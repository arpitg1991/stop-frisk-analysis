<!DOCTYPE html>
<meta charset="utf-8">
<style>

body {
  font: 10px sans-serif;
  background-color:black;
}
    
path {
        stroke: black;
        stroke-width: 0.001px;
    }
    
div.tooltip {   
  position: absolute;           
  text-align: center;           
  width: 110px;                  
  height: 35px;                 
  padding: 6px;             
  font-size: 12px;     
  background-color: rgba(28, 28, 28, 0.6);
  border: 1.5px;    
  vertical-align: middle;
  border-radius: 20px;           
  pointer-events: none; 
  color : white;
    }     
    
form {
  position: absolute;
  bottom: 10px;
  left: 10px;
}   
    
#legend {


    
</style>
<body>
    <button id = "button_totalCrimes">Total Crimes</button>
    <button id = "button_grade1">Grade 1</button>
    <button id = "button_grade2">Grade 2</button>
    <button id = "button_grade3">Grade 3</button>
    
    <script src="http://d3js.org/d3.v3.min.js"></script>
    <script src="http://d3js.org/queue.v1.min.js"></script>
    <script type="text/javascript" src="http://d3js.org/topojson.v0.min.js"></script>

    <script>
        var screenwidth = 900,
            screenheight = 800;       

// To be used for quantizing data to colors    

        var regularOpacity = 0.6

        
        var color = d3.scale.pow().exponent(0.5)
            .domain([0,5])
            .range(['pink','red'])
            .interpolate(d3.interpolateLab);

        var quantize;
        
        var margin = {top: 40, right: 20, bottom: 30, left: 40},
            width = screenwidth - margin.left - margin.right,
            height = screenheight - margin.top - margin.bottom,
            centered = null;
        
        var svg = d3.select("body").append("svg")
            .attr("width", screenwidth + margin.left + margin.right)
            .attr("height", screenheight + margin.top + margin.bottom)        
        
        var div = d3.select("body").append("div")   
            .attr("class", "tooltip")               
            .style("opacity", 0.5);
           
        var projection = d3.geo.mercator()
            .center([-73.94, 40.70])
            .scale(69000)
            .translate([(screenwidth) / 2, (screenheight)/2]);
        
        var path = d3.geo.path()
                .projection(projection);    
        
        var g = svg.append('g');

     
        function initializeMap(variable) {
            DOMAIN = d3.extent(variable)
            quantize = d3.scale.quantile()
                .domain(DOMAIN)
                .range(d3.range(5).map(function (i) { return color(i);}));
            
            
            g.selectAll("path")
                .data(topojson.object(nyp, nyp.objects.nypp).geometries)
            .enter().append("path")
            .attr('d', path)

            
            // How do we color the polygons?
            .style('fill', function(d) {
                return quantize(variable[d.id]);}).style('opacity', regularOpacity)
            
            //Adding mouseevents
            .on("mouseover", function(d) {
                d3.select(this).transition().duration(150).style("opacity", 1);
                div.transition().duration(150)
                .style("opacity", 1)
                div.text("Precinct " + nameById[d.id] + " : " + variable[d.id] + " Crimes ")
                .style("left", (d3.event.pageX) + "px")
                .style("top", (d3.event.pageY -50) + "px");})
            
            
            .on("mouseout", function() {
                d3.select(this)
                .transition().duration(150)
                .style("opacity", regularOpacity);
                div.transition().duration(150)
                .style("opacity", 0);})
            
            .on('click', clicked)
        }

        
        function ready(error, Map, Data){
        // process the data    
            // Store data from csv into arrays, whose indices match the map ids
            Data.forEach(function(d) {
                totalCrimesById[d.Precinct] = +d.Total;
                crimes1ById[d.Precinct] = +d.Grade1;
                crimes2ById[d.Precinct] = +d.Grade2;
                crimes3ById[d.Precinct] = +d.Grade3;
                nameById[d.Precinct] = +d.Precinct;
            });
                    
            nyp = Map;
        // Generate the map
                initializeMap(totalCrimesById);
            }

        var totalCrimesById = [];
        var crimes1ById = [];
        var crimes2ById = [];
        var crimes3ById = [];
        var nameById = [];
        var DOMAIN;
            
        queue()
            .defer(d3.json,"https://dl.dropboxusercontent.com/u/60227913/nycCrimeFrisk/nypp.json")
            .defer(d3.csv,"https://dl.dropboxusercontent.com/u/60227913/nycCrimeFrisk/crimeByPP2012.csv")
            .await(ready);

// ASSIGN FUNCTIONS TO BUTTONS
            
        d3.select('#button_totalCrimes').on('click', function(){
            DOMAIN = d3.extent(totalCrimesById)
            quantize = d3.scale.quantile()
                .domain(DOMAIN)
                .range(d3.range(5).map(function (i) { return color(i);}));
            
            svg.selectAll('path').style('fill', function(d) {
                return quantize(totalCrimesById[d.id]);}).style('opacity', regularOpacity)
            
            .on("mouseover", function(d) {
                d3.select(this).transition().duration(150).style("opacity", 1);
                div.transition().duration(150)
                .style("opacity", 1)
                div.text("Precinct " + nameById[d.id] + " : "
                         + totalCrimesById[d.id] + " Total crimes ")
                .style("left", (d3.event.pageX) + "px")
                .style("top", (d3.event.pageY -30) + "px");})
            
            .on("mouseout", function() {
                d3.select(this)
                .transition().duration(150)
                .style("opacity", regularOpacity);
                div.transition().duration(150)
                .style("opacity", 0);})
        })
        
        d3.select('#button_grade1').on('click', function(){
            DOMAIN = d3.extent(crimes1ById)
            quantize = d3.scale.quantile()
                .domain(DOMAIN)
                .range(d3.range(5).map(function (i) { return color(i);}));
            
            svg.selectAll('path').style('fill', function(d) {
                return quantize(crimes1ById[d.id]);}).style('opacity', regularOpacity)
            
            .on("mouseover", function(d) {
                d3.select(this).transition().duration(150).style("opacity", 1);
                div.transition().duration(150)
                .style("opacity", 1)
                div.text("Precinct " + nameById[d.id] + " : "
                         + crimes1ById[d.id] + " Grade 1 crimes ")
                .style("left", (d3.event.pageX) + "px")
                .style("top", (d3.event.pageY -30) + "px");})
            
            .on("mouseout", function() {
                d3.select(this)
                .transition().duration(150)
                .style("opacity", regularOpacity);
                div.transition().duration(150)
                .style("opacity", 0);})
        })
        
        d3.select('#button_grade2').on('click', function(){
            DOMAIN = d3.extent(crimes2ById)
            quantize = d3.scale.quantile()
                .domain(DOMAIN)
                .range(d3.range(5).map(function (i) { return color(i);}));
            
            svg.selectAll('path').style('fill', function(d) {
                return quantize(crimes2ById[d.id]);}).style('opacity', regularOpacity)
            
            .on("mouseover", function(d) {
                d3.select(this).transition().duration(150).style("opacity", 1);
                div.transition().duration(150)
                .style("opacity", 1)
                div.text("Precinct " + nameById[d.id] + " : "
                         + crimes2ById[d.id] + " Grade 2 crimes ")
                .style("left", (d3.event.pageX) + "px")
                .style("top", (d3.event.pageY -30) + "px");})
            
            .on("mouseout", function() {
                d3.select(this)
                .transition().duration(150)
                .style("opacity", regularOpacity);
                div.transition().duration(150)
                .style("opacity", 0);})
        })
        
        d3.select('#button_grade3').on('click', function(){
            DOMAIN = d3.extent(crimes3ById)
            quantize = d3.scale.quantile()
                .domain(DOMAIN)
                .range(d3.range(5).map(function (i) { return color(i);}));
            
            svg.selectAll('path').style('fill', function(d) {
                return quantize(crimes3ById[d.id]);}).style('opacity', regularOpacity)
            
            .on("mouseover", function(d) {
                d3.select(this).transition().duration(150).style("opacity", 1);
                div.transition().duration(150)
                .style("opacity", 1)
                div.text("Precinct " + nameById[d.id] + " : "
                         + crimes3ById[d.id] + " Grade 3 crimes ")
                .style("left", (d3.event.pageX) + "px")
                .style("top", (d3.event.pageY -30) + "px");})
            
            .on("mouseout", function() {
                d3.select(this)
                .transition().duration(150)
                .style("opacity", regularOpacity);
                div.transition().duration(150)
                .style("opacity", 0);})
        })
        
                        

        

// PAN ONLY
        /*
        function clicked(d){
            var x = 0;
            var y = 0;
            
            if (!d || centered ===d) {
                centered = null;
            }
            else {
                var centroid = path.centroid(d);
                x = width / 2 - centroid[0];
                y = height / 2 - centroid[1];
                centered = d;
            }
            
            g.transition()
                .duration(350)
                .attr('transform', 'translate(' + x + ',' + y + ')');
        }
        */
        
// ZOOM AND PAN
        function clicked(d){
            var x,y,k;
            
            if (d && centered !== d ) {
                var centroid = path.centroid(d);
                x = centroid[0]
                y = centroid[1];
                k = 2;
                centered = d;
            }
            else {
                x = width / 2;
                y = height / 2;
                k = 1;
                centered = null;
            }
            
            g.selectAll('path')
                .classed('active', centered && function(d) { return d === centered; } ) ;
            
            g.transition()
                .duration(350)
                .attr('transform', 'translate(' + width / 2 + ',' + height/2 + ')scale(' + k + ')translate(' + -x + ',' + -y + ')')
                .style('stroke-width', 1.5/k + 'px');

            // When we focus, let's remove the tool tip, but supplement with a data table at the corner

            if (! d || centered === d){
            d3.select(this)
                .transition().duration(150)
                .style("opacity", 1);
            
            div.transition().duration(300)
                //.style("opacity", 0)
                .style("left", (screenwidth - 170) + "px")
                .style("top", (screenheight - 100) + "px") 
                .style('height', 200 + 'px')
                .style('width', 200 + 'px')
            }
            else {
            d3.select(this)
                .transition().duration(150)
                .style("opacity", 1);
                
            div.transition().duration(150)
            //.style("opacity", 0)
            .style('height', 40 + 'px')
            .style('width', 110 + 'px')
            }
        }       
        
    </script>
