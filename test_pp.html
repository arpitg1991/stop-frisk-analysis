<!DOCTYPE html>
<meta charset="utf-8">
<style>

body {
  font: 10px sans-serif;
  background-color:black;
}
    
path {
        stroke: black;
        stroke-width: 0.5px;
    }
    
div.tooltip {   
  position: absolute;           
  text-align: center;           
  width: 110px;                  
  height: 35px;                 
  padding: 6px;             
  font-size: 12px;     
  background-color: rgba(28, 28, 28, 0.6);
  border: 1.5px;    
  vertical-align: middle;
  border-radius: 20px;           
  pointer-events: none; 
  color : white;
    }     
    
form {
  position: absolute;
  bottom: 10px;
  left: 10px;
}   
    

    
</style>
<body>
    <button id = "button2001">2001</button>
    <button id = "button2012">2012</button>
    
    <script src="http://d3js.org/d3.v3.min.js"></script>
    <script src="http://d3js.org/queue.v1.min.js"></script>
    <script type="text/javascript" src="http://d3js.org/topojson.v0.min.js"></script>

    <script>
        var screenwidth = 900,
            screenheight = 800;       

// To be used for quantizing data to colors    
        var color_domain = [-30, 0, 500, 1000, 2000, 5000]
        
        var color = d3.scale.threshold()
            .domain(color_domain)
            .range(["#adfcad", "#ffcb40", "#ffba00", "#ff7d73", "#ff4e40", "#ff1300"]);    
         
        var margin = {top: 40, right: 20, bottom: 30, left: 40},
            width = screenwidth - margin.left - margin.right,
            height = screenheight - margin.top - margin.bottom,
            centered = null;
        
        var svg = d3.select("body").append("svg")
            .attr("width", screenwidth + margin.left + margin.right)
            .attr("height", screenheight + margin.top + margin.bottom)        
        
        var div = d3.select("body").append("div")   
            .attr("class", "tooltip")               
            .style("opacity", 0.5);
           
        var projection = d3.geo.mercator()
            .center([-73.94, 40.70])
            .scale(69000)
            .translate([(screenwidth) / 2, (screenheight)/2]);
        
        var path = d3.geo.path()
                .projection(projection);    
        
        var g = svg.append('g');

        
        function initializeMap(variable) {
            g.selectAll("path")
                .data(topojson.object(nyp, nyp.objects.nypp).geometries)
            .enter().append("path")
            .attr('d', path)

            
            // How do we color the polygons?
            .style('fill', function(d) {
                return color(variable[d.id]);}).style('opacity', 0.6)
            
            //Adding mouseevents
            .on("mouseover", function(d) {
                d3.select(this).transition().duration(150).style("opacity", 1);
                div.transition().duration(150)
                .style("opacity", 1)
                div.text("Precinct " + nameById[d.id] + " : " + variable[d.id] + " Crimes ")
                .style("left", (d3.event.pageX) + "px")
                .style("top", (d3.event.pageY -50) + "px");})
            
            
            .on("mouseout", function() {
                d3.select(this)
                .transition().duration(150)
                .style("opacity", 0.6);
                div.transition().duration(150)
                .style("opacity", 0);})
            
            .on('click', clicked)
        }

        
        
        function ready(error, Map, Data){
        // process the data    
            // Store data from csv into arrays, whose indices match the map ids
            Data.forEach(function(d) {
                rateById[d.Precinct] = +d.crime2012;
                rate2ById[d.Precinct] = +d.crime2001;
                nameById[d.Precinct] = +d.Precinct;
            });
                    
            nyp = Map;
        // Generate the map
                initializeMap(rateById);
            }

        var rateById = {};
        var rate2ById = {};
        var nameById = {};
        var colorById = {};
            
        queue()
            .defer(d3.json, "data/nypp.json")
            .defer(d3.csv, "data/crimeData.csv")
            .await(ready);
        
            
        d3.select('#button2001').on('click', function(){
            
            svg.selectAll('path').style('fill', function(d) {
                return color(rate2ById[d.id]);}).style('opacity', 0.6)            
            .on("mouseover", function(d) {
                d3.select(this).transition().duration(150).style("opacity", 1);
                div.transition().duration(150)
                .style("opacity", 1)
                div.text("Precinct " + nameById[d.id] + " : " + rate2ById[d.id] + " Crimes ")
                .style("left", (d3.event.pageX) + "px")
                .style("top", (d3.event.pageY -30) + "px");})
            
            .on("mouseout", function() {
                d3.select(this)
                .transition().duration(150)
                .style("opacity", 0.6);
                div.transition().duration(150)
                .style("opacity", 0);})
        })
        
        d3.select('#button2012').on('click', function(){           
            
            svg.selectAll('path').style('fill', function(d) {
                return color(rateById[d.id]);}).style('opacity', 0.6)
            
            .on("mouseover", function(d) {
                d3.select(this).transition().duration(150).style("opacity", 1);
                div.transition().duration(150)
                .style("opacity", 1)
                div.text("Precinct " + nameById[d.id] + " : " + rateById[d.id] + " Crimes ")
                .style("left", (d3.event.pageX) + "px")
                .style("top", (d3.event.pageY -30) + "px");
            })            
            
            .on("mouseout", function() {
                d3.select(this)
                .transition().duration(150)
                .style("opacity", 0.6);
                div.transition().duration(150)
                .style("opacity", 0);})
        })
        

// PAN ONLY
        /*
        function clicked(d){
            var x = 0;
            var y = 0;
            
            if (!d || centered ===d) {
                centered = null;
            }
            else {
                var centroid = path.centroid(d);
                x = width / 2 - centroid[0];
                y = height / 2 - centroid[1];
                centered = d;
            }
            
            g.transition()
                .duration(350)
                .attr('transform', 'translate(' + x + ',' + y + ')');
        }
        */
        
// ZOOM AND PAN
        function clicked(d){
            var x,y,k;
            
            if (d && centered !== d ) {
                var centroid = path.centroid(d);
                x = centroid[0]
                y = centroid[1];
                k = 3;
                centered = d;
            }
            else {
                x = width / 2;
                y = height / 2;
                k = 1;
                centered = null;
            }
            
            g.selectAll('path')
                .classed('active', centered && function(d) { return d === centered; } ) ;
            
            g.transition()
                .duration(350)
                .attr('transform', 'translate(' + width / 2 + ',' + height/2 + ')scale(' + k + ')translate(' + -x + ',' + -y + ')')
                .style('stroke-width', 1.5/k + 'px');

            // When we focus, let's remove the tool tip, but supplement with a data table at the corner
            d3.select(this)
                .transition().duration(150)
                .style("opacity", 1);
            
            if (! d || centered === d){
            div.transition().duration(300)
                //.style("opacity", 0)
                .style("left", (screenwidth - 170) + "px")
                .style("top", (screenheight - 100) + "px") 
                .style('height', 200 + 'px')
                .style('width', 200 + 'px')
            }
            else {
            div.transition().duration(150)
            //.style("opacity", 0)
            .style('height', 40 + 'px')
            .style('width', 110 + 'px')
            }
        }       
        
    </script>
