<!DOCTYPE html>
<meta charset="utf-8">
<style>

body {
  font: 10px sans-serif;
  background-color:black;
}
    
path {
        stroke: black;
        stroke-width: 1px;
    }
    
div.tooltip {   
  position: absolute;           
  text-align: center;           
  width: 150px;                  
  height: 25px;                 
  padding: 2px;             
  font-size: 10px;     
  background: #FFFFE0;
  border: 1px;      
  border-radius: 8px;           
  pointer-events: none;         
}     
        
</style>
<body>
<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="http://labratrevenge.com/d3-tip/javascripts/d3.tip.min.js"></script>
<script src="http://d3js.org/queue.v1.min.js"></script>
<script type="text/javascript" src="http://d3js.org/topojson.v0.min.js"></script>

<script>
var screenwidth = 900,
   screenheight = 800;       

// To be used for quantizing data to colors    
var color_domain = [-30, 0, 500, 1000, 2000, 5000]
var color = d3.scale.threshold()
  .domain(color_domain)
  .range(["#adfcad", "#ffcb40", "#ffba00", "#ff7d73", "#ff4e40", "#ff1300"]);    
    
    
 
var margin = {top: 40, right: 20, bottom: 30, left: 40},
    width = 960 - margin.left - margin.right,
    height = 500 - margin.top - margin.bottom;

var x = d3.scale.ordinal()
    .rangeRoundBands([0, width], .1);

var y = d3.scale.linear()
    .range([height, 0]);

var svg = d3.select("body").append("svg")
    .attr("width", screenwidth + margin.left + margin.right)
    .attr("height", screenheight + margin.top + margin.bottom)


var div = d3.select("body").append("div")   
    .attr("class", "tooltip")               
    .style("opacity", 0);
   
var projection = d3.geo.mercator()
    .center([-73.94, 40.70])
    .scale(69000)
    .translate([(screenwidth) / 2, (screenheight)/2]);

var path = d3.geo.path()
        .projection(projection);    
    
    
    
queue()
    .defer(d3.json, "data/nypp.json")
    .defer(d3.csv, "data/crimeTest.csv")
    .await(ready);
    
function prepareMap() {
    svg.append("g")
        .attr("class", "boroughs")
    .selectAll("path")
        .data(topojson.object(nyp, nyp.objects.nypp).geometries)
    .enter().append("path")
    .attr('d', path)
    
    // How do we color the polygons?
    .style('fill', function(d) {
        return color(rateById[d.id]);}).style('opacity', 0.8)

    
  //Adding mouseevents
  .on("mouseover", function(d) {
    d3.select(this).transition().duration(300).style("opacity", 1);
    div.transition().duration(300)
    .style("opacity", 1)
    div.text("Precinct " + nameById[d.id] + " : " + rateById[d.id] + " Crimes ")
    .style("left", (d3.event.pageX) + "px")
    .style("top", (d3.event.pageY -30) + "px");
  })
    
  .on("mouseout", function() {
    d3.select(this)
    .transition().duration(300)
    .style("opacity", 0.8);
    div.transition().duration(300)
    .style("opacity", 0);
  })
}
        
// Initialize arrays to hold the data
var rateById = {};
var nameById = {};
var colorById = {};

function ready(error, Map, Data){
// process the data    
    // Store data from csv into arrays, whose indices match the map ids
    Data.forEach(function(d) {
        rateById[d.Precinct] = +d.crime;
        nameById[d.Precinct] = +d.Precinct;
//        colorById[d.BoroCode] = d.color;
    });
    nyp = Map;
// Generate the map
   prepareMap();    
}
 
</script>
